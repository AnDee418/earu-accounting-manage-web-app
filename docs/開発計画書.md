# 経費精算アプリ 開発計画書

**Flutter × Firebase（サーバーレス）× Gemini 2.5 × Document AI｜PCAクラウド（CSV連携）**
版数: v1.0｜作成日: 2025-08-20

---

## 0. 目的・背景

* 全国の社員がスマホで領収書を撮影し、AIが自動で項目抽出・勘定科目推定→本人確認→提出できる仕組みを作る。
* 経理担当者はWebで一括レビュー・修正・差戻し・承認し、**PCAクラウド会計へCSVで連携**する。
* 手作業の画像/Excel授受を廃止し、処理の可視化・トレーサビリティ・監査性を高める。

**達成したい状態**

* 社員: 「撮る→AI→提出」まで1件あたり1分以内。
* 経理: 承認済みデータをワンクリックでCSV出力し、PCAに取込。再作業・差戻し率を継続的に削減。

---

## 1. 成功指標 (KPI)

* 平均リードタイム: 提出→承認→PCA連携まで **当日～翌営業日**。
* 経理の手修正率: **50%削減**（MVP目標: 30%）。
* 差戻し率: **30%削減**（理由の上位3つをダッシュボードで可視化）。
* 二重計上検知の再発率: **1%以下**。

---

## 2. スコープ定義

### 2.1 MUST（MVPに含める）

* Flutterモバイル（iOS/Android）: 撮影/アップロード、AI抽出、編集、提出、ステータス確認、個人分析。
* Webアプリ（経理・部署管理者用）: レビュー、承認/差戻し/修正、部署分析、CSVエクスポート。
* バックエンド: Firebase Auth / Firestore / Storage / Cloud Functions / App Check / FCM。
* AI: Google Document AI（Expense/Invoice Parser）＋ Gemini 2.5（構造化・カテゴリ推定・例外補完）。
* PCAクラウド: **CSVインポート**（手動取込）。

### 2.2 SHOULD（MVP+）

* 旅費精算ウィザード（区間・交通手段、IC明細CSV取込）。
* 重複検知（指紋＋項目近接）。
* 監査ログ（誰が/いつ/何を修正）。

### 2.3 COULD（将来）

* PCAクラウド Web-API 直接連携（契約後）。
* 電子帳簿保存法「スキャナ保存」対応強化（タイムスタンプ等、別途要件定義）。
* SSO（Azure AD/Google Workspace制限）、承認フローの多段化（上長→経理）。

### 2.4 OUT（対象外）

* 給与精算、債務計上以外の会計領域。
* 海外法人向け税制固有仕様（必要に応じ別PJ）。

---

## 3. 体制・役割（RACI）

| 領域             | 責任(R)     | 実行(A)            | 相談(C)        | 連絡(I) |
| -------------- | --------- | ---------------- | ------------ | ----- |
| 要件定義・UAT       | プロダクトオーナー | PM/BA            | 経理責任者, 部署管理者 | 全社    |
| アーキ/セキュリティ     | テックリード    | 開発チーム            | 情シス, セキュリティ  | PM    |
| モバイル(FE)       | モバイルTL    | Flutter Dev      | QA           | PM    |
| Web(FE)        | Web TL    | Web Dev          | QA           | PM    |
| バックエンド/AI      | BE TL     | Functions/AI Dev | テックリード       | PM    |
| インフラ(Firebase) | テックリード    | DevOps           | 情シス          | PM    |
| 会計連携(CSV)      | 経理責任者     | BE Dev           | PCA担当        | PM    |
| QA/テスト         | QAリード     | QA               | 開発全員         | PM    |

---

## 4. スケジュール（12週間想定）

**W1–2: 要件・基盤**

* 要件合意（業務フロー、PCA CSVサンプル収集、勘定科目/税区分/部門マスタ）。
* Firebaseプロジェクト（dev/stg/prod）、Auth/Firestore/Storage/Rules初期設定、App Check有効化。
* Flutter雛形（モバイル/ウェブ）とCI準備。

**W3–4: AIパイプライン（MVP版）**

* Storageトリガー→Document AI→正規化→Firestore書込み。
* Gemini 2.5でカテゴリ推定・構造化（JSONスキーマ）・信頼度算出。
* 重複検知の初期版（店名×日時×総額×下4桁＋画像指紋）。

**W5–6: モバイルUX/提出フロー**

* 撮影/トリミング/ゆがみ補正、AI結果編集、下書き→提出、ステータスと通知。
* 個人分析（期間、科目別、推移）。

**W7–8: 経理Web/部署分析**

* レビュー/承認/差戻し/修正、監査ログ、部署管理者ダッシュボード。
* エクスポート設定UI（勘定科目・税区分・部門→PCA項目マッピング）。

**W9: PCA CSV出力**

* 承認済みデータ→CSV生成（文字コード, 桁/小数点, 税処理仕様反映）。
* ダウンロード履歴管理、再出力/差分出力対応。

**W10: 非機能/セキュリティ**

* ルール精緻化、権限テスト、レート制御、監視・予算アラート。

**W11: 総合テスト/UAT**

* 業務シナリオ、クローズドβ（3部署）、KPI測定。

**W12: リリース/教育**

* パイロット本番、経理/社員トレーニング、運用引継ぎ。

---

## 5. システム構成（サーバーレス）

* クライアント: Flutter（iOS/Android/必要に応じWeb）。
* 認証: Firebase Auth（Google/Microsoft/メールOTP）。
* データ: Cloud Firestore（経費/承認/マスタ/設定）。
* ファイル: Cloud Storage（画像/PDF原本、CSV出力）。
* サーバーレス: Cloud Functions（HTTP/Storageトリガー、CSV生成、通知、集計）。
* セキュリティ: Firestore/Storage Rules、App Check、RBAC。
* 配信: Firebase Hosting（Web）、Cloud Messaging（通知）。
* 監視: Cloud Logging, Error Reporting, Performance Monitoring。
* リージョン: asia-northeast1（東京）優先、BCPでバックアップを大阪。

---

## 6. 環境設計

* プロジェクト: `corp-expense-dev/stg/prod`（分離）
* 名前規約: `companies/{companyId}/...`、`expenses/{expenseId}` 等。
* 機密: APIキー・サービスアカウントはSecrets Manager。
* ブランチ戦略: trunk-based + feature branches。CIでlint/test/build。

---

## 7. セキュリティ/ガバナンス

* **RBAC**: `staff / manager / finance / admin`。Custom Claimsでロール＆departmentId付与。
* **Firestore Rules**: 会社ID一致、role別にread/write制限。更新はサーバー検証を通過必須。
* **Storage Rules**: ユーザー自身のファイルと所属会社のみ。公開URL禁止。
* **App Check**: 全リソースに必須化。
* **個人情報**: カード番号等の自動マスキング（検出→黒塗り）オプション。
* **監査ログ**: 重要操作（承認/修正/エクスポート）を別コレクションに冪等記録。
* **データ保持**: 原本画像は5～7年相当（社内規程に準拠）。
* **電帳法**: スキャナ保存の要件は**別途要件定義**（タイムスタンプ、解像度、検索性、真正性担保）。

---

## 8. データモデル

```text
/companies/{companyId}
/users/{userId} {
  role: 'staff'|'manager'|'finance'|'admin',
  companyId, departmentId, email, name
}
/departments/{departmentId} { name, managerIds: [userId], companyId }
/accounts/{accountId} { name, code, taxCode, pcaCode, companyId }
/categories/{categoryId} { name, defaultDebitAccountId, defaultCreditAccountId, taxRule, hints[] }
/exportProfiles/{profileId} { name: 'PCA', encoding: 'Shift_JIS|UTF-8', mappingJson }
/expenses/{expenseId} {
  userId, companyId, departmentId, projectCode,
  status: 'draft'|'submitted'|'approved'|'rejected'|'exported',
  type: 'receipt'|'travel'|'invoice',
  currency, total, tax, subtotal, taxRate, paidAt,
  merchant, categoryId, note,
  ai: { engine: 'docai'|'gemini', confidence: 0..1, rawJsonRef },
  duplicateIds: [expenseId],
  approverId, approvedAt, rejectedReason,
  pcaStatus: 'pending'|'exported'|'error', pcaJournalId, exportAt,
  createdAt, updatedAt
}
/expense_files/{expenseId}/{fileId} { gcsPath, page, pageCount, ocrStatus, uploadedAt }
/auditLogs/{logId} { actorId, action, targetId, before, after, at }
```

**インデックス例**: `expenses` の `companyId+status+paidAt(desc)`、`departmentId+paidAt`、`userId+status`。

---

## 9. AI/ETL パイプライン詳細

1. **アップロード**: モバイル→Storage（クライアント圧縮・ゆがみ補正）。
2. **トリガー**: Storage finalize → Functions起動。
3. **抽出①**: Document AI Expense/Invoice Parserで主要項目（日期/店名/合計/税/通貨/明細）。
4. **正規化**: 日付/通貨/税率の標準化、数値桁調整。
5. **抽出②**: Gemini 2.5でカテゴリ推定・曖昧補完・JSONスキーマ検証（信頼度付与）。
6. **重複検知**: `(merchant, paidAt±15min, total, last4digits)` のハッシュ＋画像指紋近似。
7. **保存**: Firestoreにドラフト作成、ai結果と信頼度、不足項目フラグ。
8. **通知**: しきい値以下/不足時はユーザーへ補完依頼通知。

**Gemini構造化出力スキーマ（例）**

```json
{
  "paidAt": "YYYY-MM-DD",
  "currency": "JPY",
  "total": 1234.56,
  "tax": 112.23,
  "merchant": "string",
  "suggestedCategoryId": "ref",
  "confidence": 0.0
}
```

**信頼度しきい値**: `>=0.85` 自動確定、`0.6–0.85` ユーザー確認、`<0.6` 入力必須。

---

## 10. 業務ワークフロー詳細

### 10.1 社員（モバイル）

1. 撮影/アップロード → AI抽出結果レビュー。
2. 必須項目チェック（合計/日付/科目/部署）。
3. 提出（`status=submitted`）。
4. ステータス追跡（差戻し理由はテンプレ＋自由記述）。
5. 個人ダッシュボード（期間、科目別、推移、上位店）。

### 10.2 部署管理者（分析専用）

* 部門合計、科目内訳、メンバー別ランキング、月次推移、フィルタ（期間/メンバー/科目）。

### 10.3 経理（Web）

1. 受信ボックス（新着/フィルタ/検索）。
2. 画像＋AI/ユーザー入力の差分ハイライト、修正機能。
3. 一括承認/差戻し、監査ログ自動記録。
4. 承認済み→CSVエクスポート（PCAプロファイル選択）。
5. 取込結果を記録（手動完了チェック/備考）。

---

## 11. UI/UX 画面一覧

### モバイル

* サインイン/初期プロフィール
* ホーム（未提出/差戻し/承認待ち/承認済み）
* 新規経費（カメラ/ギャラリー/PDF、トリミング、ページ分割）
* AI結果編集フォーム（必須ガイド、重複アラート、信頼度表示）
* 提出確認モーダル
* 個人ダッシュボード（円/棒/折れ線、期間プリセット）
* 通知センター

### Web（経理/部署管理者）

* ログイン
* 受信ボックス（テーブル + 右ペイン詳細）
* 詳細（画像ビューア、AI vs 手入力差分、編集）
* 一括操作（承認/差戻し）
* 部署/全社ダッシュボード
* エクスポート履歴・管理
* 管理: マスタ（勘定科目/税/部署/プロジェクト）、PCAエクスポート設定

---

## 12. PCAクラウド（CSV）連携設計

### 12.1 方式

* **承認済み**の経費のみ対象。
* FunctionsでCSV生成→Storage（`exports/pca/YYYYMM/pca_export_YYYYMMDD_HHmm.csv`）。
* Webからダウンロード（履歴表示/再出力/差分出力）。

### 12.2 文字コード/区切り/書式

* 文字コード: **要確認**（PCA運用環境に合わせ `Shift_JIS` か `UTF-8`）。
* 区切り: カンマ or タブ（要確認）。
* 改行: CRLF。
* 日付: `YYYY/MM/DD`、金額: 小数点/端数処理は税設定に準拠。

### 12.3 マッピング（例: 仕訳取込）

| 項目   | 値の出所                                                  | 例          |
| ---- | ----------------------------------------------------- | ---------- |
| 伝票日付 | `expenses.paidAt`                                     | 2025/08/20 |
| 借方科目 | `categories.defaultDebitAccountId → accounts.pcaCode` | 旅費交通費      |
| 借方補助 | 任意（プロジェクト/社員）                                         | 1001       |
| 貸方科目 | 立替/現金/未払経費など                                          | 現金         |
| 金額   | `expenses.total`                                      | 15000      |
| 税    | `taxCode`/`taxRate`                                   | 課税/非課税等    |
| 摘要   | `merchant`＋`note`                                     | 出張：東京→大阪   |

### 12.4 設定UI

* **エクスポートプロファイル**: 文字コード、区切り、列順、税計算方式、科目マッピング、摘要フォーマット。
* **テスト出力**: 1件/10件のサンプルCSVを即時生成し、PCA側で検証。

### 12.5 冪等性/再出力

* 各経費の `pcaStatus` と `exportAt` を管理。再出力は差分/全量を選択可能。

---

## 13. 設定/マスタ管理

* **勘定科目**（code, name, taxCode, pcaCode）。
* **税区分**（税率, 端数処理, 課税/非課税）。
* **部署**（departmentId, name, managerIds）。
* **プロジェクト**（任意）。
* **カテゴリ**（AI推奨に紐付け、デフォルト借方/貸方）。
* **エクスポートプロファイル**（PCA用テンプレ）。

---

## 14. 通知/監視/観測性

* **通知**: 提出/差戻し/承認/エクスポート完了をFCMで配信。
* **監視**: Cloud Monitoringダッシュボード（Functions遅延、エラー率、ストレージ使用量）。
* **アラート**: 失敗率>2%、レイテンシ>p95 2s、請求額急増でBudgetアラート。
* **ログ**: 重要イベントを構造化ログ出力＋長期保管バケットへエクスポート。

---

## 15. 非機能要件

* 可用性: 99.9%（Firebase依存）。
* 性能: 1ページ抽出→AI→ドラフト反映まで p95 < 6秒/件（回線除く）。
* スループット: 5,000件/日までスケール（Functions並列/キュー）。
* 保持: 経費データ7年、ログ3年（社内規程に準拠）。
* 端末対応: iOS 15+/Android 9+。
* アクセシビリティ: 文字サイズ拡大、色弱配慮、キーボード操作対応（Web）。

---

## 16. テスト計画

* **単体/Widget/Integration**（Flutter, Functions）。
* **AI精度検証**: 100枚セット×3難易度で精度・再現率を測定、誤判定上位パターンを学習に反映。
* **E2E**: Firebase Emulator Suiteで提出→承認→CSV生成まで自動化。
* **性能**: 連続1,000件投入、キュー遅延とコスト測定。
* **セキュリティ**: ルール回避テスト、権限昇格の防止、ファイル直リンク遮断。
* **UAT**: 3部署の実データで業務シナリオ確認、KPI測定。

---

## 17. リリース/運用

* 段階リリース: 社内パイロット→全社展開。ストア配布は社内配布（iOS/Android）を優先。
* 教育: 1時間の操作トレーニング＋クイックリファレンスPDF。
* 運用: 月次エクスポート作業手順、差戻しのベストプラクティス、FAQ整備。
* 保守: ライブラリアップデート、セキュリティパッチ、AIモデル設定の見直し（月次）。

---

## 18. リスクと対応

* **AI誤判定**: しきい値制御＋ユーザー確認＋学習ループ。
* **スキャン品質**: 端末側でコントラスト強調/ゆがみ補正、再撮影プロンプト。
* **PCA取込エラー**: 文字コード/桁/税ルールの差異 → テンプレプロファイルで吸収、サンプルで事前検証。
* **電帳法要件**: 別途要件定義とガイドライン整備、将来のタイムスタンプ連携余地を確保。
* **拡張**: PCA API化に備え、エクスポート層を抽象化（CSV/HTTPコネクタの2実装）。

---

## 19. コスト概算（参考）

* Document AI: 約 **\$0.01/ページ** × 月間件数。
* Firebase: Firestore/Storage/Functions の使用量課金（初期は数千円/月想定）。
* 監視/ログ/転送: 数百円～数千円/月。
  ※ 実運用データ確定後に見直し。

---

## 20. 次のアクション（依頼事項）

1. **PCA取込サンプルCSV** の提示（現在運用中の形式）。
2. **勘定科目表・税区分・部門一覧** の提供（コード/名称）。
3. 初期対象部署（3〜5部署）と担当者の指名（パイロット用）。
4. スマホ対応ポリシー（BYOD可否、推奨端末、OSバージョン）。
5. 電帳法「スキャナ保存」を将来対象に含めるかの方針決定。

---

## 付録A: Firestore Security ルール（抜粋・概念）

```js
match /databases/{database}/documents {
  function isCompanyMember(companyId) {
    return request.auth != null && request.auth.token.companyId == companyId;
  }
  function hasRole(role) {
    return request.auth != null && request.auth.token.role == role;
  }

  match /companies/{companyId}/expenses/{expenseId} {
    allow read, write: if false; // デフォルト拒否

    allow read: if isCompanyMember(companyId) && (
      hasRole('finance') ||
      (hasRole('manager') && request.auth.token.departmentId == resource.data.departmentId) ||
      (hasRole('staff') && request.auth.uid == resource.data.userId)
    );

    allow create: if isCompanyMember(companyId) && hasRole('staff') &&
      request.resource.data.userId == request.auth.uid;

    allow update: if isCompanyMember(companyId) && (
      hasRole('finance') ||
      (hasRole('staff') && request.auth.uid == resource.data.userId && resource.data.status == 'draft')
    );
  }
}
```

---

## 付録B: エクスポートマッピングJSON（例）

```json
{
  "profileName": "PCA_Default",
  "encoding": "Shift_JIS",
  "delimiter": ",",
  "dateFormat": "YYYY/MM/DD",
  "columns": [
    { "name": "date", "from": "expenses.paidAt" },
    { "name": "debit", "from": "categories.defaultDebitAccountId -> accounts.pcaCode" },
    { "name": "credit", "from": "config.defaultCreditAccountId -> accounts.pcaCode" },
    { "name": "amount", "from": "expenses.total" },
    { "name": "taxCode", "from": "accounts.taxCode" },
    { "name": "summary", "from": "template('${merchant} ${note}')" }
  ]
}
```

---

## 付録C: Functions エンドポイント（例）

* `onStorageFinalize`: 画像アップロード → AI抽出 → Firestore保存。
* `POST /export/pca`: 期間/部署/承認状態フィルタでCSV生成、Storageへ保存。
* `POST /expenses/:id/retry-ai`: 失敗時の再解析。
* `POST /expenses/:id/recalculate`: 税/端数再計算。

---

## 付録D: Gemini プロンプト雛形（構造化）

```
あなたは経費領収書の構造化アシスタントです。以下のJSONスキーマに**厳密**に従い、欠損はnull、数値は数値型で返すこと。
返答は日本語テキストを含めず、**JSONのみ**で出力：
{
  "paidAt": "YYYY-MM-DD",
  "merchant": "string",
  "currency": "ISO-4217",
  "total": number,
  "tax": number,
  "suggestedCategoryId": "string",
  "confidence": number
}
```

---

## 付録E: データ保持/削除ポリシー（例）

* ドラフト: 90日未更新で自動削除（通知の上）。
* 差戻し: 180日でアーカイブ。
* 承認済み: 7年保管、CSV出力物も同期間保持。

---

## 付録F: 運用手順（サンプル）

1. 月末締め翌5営業日: 経理は承認漏れを確認し、残件を差戻し依頼。
2. 承認完了後: 期間でCSV出力（PCAプロファイル選択）。
3. PCAクラウド: 取込→検証→完了。必要に応じFunctions側で`exported`へ更新。
4. エラーはWebのエクスポート履歴から再出力。

---

以上。
